<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–®–∞—Ö–º–∞—Ç—ã —Å –ø–∞–ø–æ–π –æ–Ω–ª–∞–π–Ω</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
        }
        h1 { color: white; margin: 10px 0; font-size: 24px; text-align: center; }
        .dad-message {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            margin-bottom: 15px;
            font-size: 22px;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .room-info {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            text-align: center;
            max-width: 100%;
        }
        .room-code {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }
        button {
            background: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        .status {
            background: white;
            padding: 10px 20px;
            border-radius: 10px;
            margin-bottom: 10px;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
        }
        .board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 0;
            border: 3px solid #333;
            border-radius: 5px;
            max-width: 100vw;
            aspect-ratio: 1;
            width: 100%;
            max-width: 400px;
        }
        .cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(24px, 8vw, 40px);
            cursor: pointer;
            user-select: none;
        }
        .white { background: #f0d9b5; }
        .black { background: #b58863; }
        .selected { background: #7b61ff !important; }
        .valid-move { background: #90EE90 !important; }
        input {
            padding: 10px;
            font-size: 16px;
            border-radius: 5px;
            border: 2px solid #ddd;
            margin: 5px;
            text-align: center;
            text-transform: uppercase;
        }
        @media (max-width: 400px) {
            .cell { font-size: 28px; }
            .dad-message { font-size: 18px; padding: 15px 20px; }
        }
    </style>
</head>
<body>
    <h1>‚ôüÔ∏è –®–ê–•–ú–ê–¢–´ –° –ü–ê–ü–û–ô ‚ôüÔ∏è</h1>
    <div class="dad-message">‚ù§Ô∏è –ü–∞–ø, –¥–∞–≤–∞–π —Å—ã–≥—Ä–∞–µ–º –≤ —à–∞—Ö–º–∞—Ç—ã! ‚ù§Ô∏è</div>
    
    <div class="room-info" id="roomSection">
        <h3>–°–æ–∑–¥–∞—Ç—å –∏–ª–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∏–≥—Ä–µ</h3>
        <button onclick="createRoom()">üéÆ –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
        <br><br>
        <input type="text" id="roomInput" placeholder="–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã" maxlength="6">
        <button onclick="joinRoom()">üîó –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
    </div>
    
    <div class="status" id="status">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
    <div class="board" id="board"></div>

    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyALZnPwbUASl4wBa5q8XWKnH7k7JFUxDPc",
            authDomain: "chess-with-dad.firebaseapp.com",
            databaseURL: "https://chess-with-dad-default-rtdb.firebaseio.com",
            projectId: "chess-with-dad",
            storageBucket: "chess-with-dad.firebasestorage.app",
            messagingSenderId: "1065127986870",
            appId: "1:1065127986870:web:67656d8d6d3859a1348817"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        let roomId = null;
        let playerColor = null;
        let board = [];
        let selectedCell = null;
        let currentTurn = 'white';
        let gameStarted = false;
        let validMoves = [];
        
        const pieces = {
            'K': '‚ôî', 'Q': '‚ôï', 'R': '‚ôñ', 'B': '‚ôó', 'N': '‚ôò', 'P': '‚ôô',
            'k': '‚ôö', 'q': '‚ôõ', 'r': '‚ôú', 'b': '‚ôù', 'n': '‚ôû', 'p': '‚ôü'
        };
        
        const initialBoard = [
            ['r','n','b','q','k','b','n','r'],
            ['p','p','p','p','p','p','p','p'],
            ['','','','','','','',''],
            ['','','','','','','',''],
            ['','','','','','','',''],
            ['','','','','','','',''],
            ['P','P','P','P','P','P','P','P'],
            ['R','N','B','Q','K','B','N','R']
        ];
        
        // ‚úÖ –ü–†–û–í–ï–†–ö–ê –ü–†–ê–í–ò–õ–¨–ù–û–°–¢–ò –•–û–î–ê
        function isValidMove(fromRow, fromCol, toRow, toCol, boardState) {
            const piece = boardState[fromRow][fromCol];
            if (!piece) return false;
            
            const targetPiece = boardState[toRow][toCol];
            const isWhite = piece === piece.toUpperCase();
            const isTargetWhite = targetPiece && targetPiece === targetPiece.toUpperCase();
            
            // –ù–µ–ª—å–∑—è —Å—ä–µ—Å—Ç—å —Å–≤–æ—é —Ñ–∏–≥—É—Ä—É
            if (targetPiece && isWhite === isTargetWhite) return false;
            
            const pieceType = piece.toLowerCase();
            const rowDiff = toRow - fromRow;
            const colDiff = toCol - fromCol;
            const absRowDiff = Math.abs(rowDiff);
            const absColDiff = Math.abs(colDiff);
            
            switch(pieceType) {
                case 'p': // –ü–ï–®–ö–ê
                    return isValidPawnMove(fromRow, fromCol, toRow, toCol, piece, boardState);
                case 'r': // –õ–ê–î–¨–Ø
                    return isValidRookMove(fromRow, fromCol, toRow, toCol, boardState);
                case 'n': // –ö–û–ù–¨
                    return (absRowDiff === 2 && absColDiff === 1) || (absRowDiff === 1 && absColDiff === 2);
                case 'b': // –°–õ–û–ù
                    return isValidBishopMove(fromRow, fromCol, toRow, toCol, boardState);
                case 'q': // –§–ï–†–ó–¨
                    return isValidRookMove(fromRow, fromCol, toRow, toCol, boardState) || 
                           isValidBishopMove(fromRow, fromCol, toRow, toCol, boardState);
                case 'k': // –ö–û–†–û–õ–¨
                    return absRowDiff <= 1 && absColDiff <= 1;
                default:
                    return false;
            }
        }
        
        function isValidPawnMove(fromRow, fromCol, toRow, toCol, piece, boardState) {
            const direction = piece === 'P' ? -1 : 1; // –ë–µ–ª—ã–µ –∏–¥—É—Ç –≤–≤–µ—Ä—Ö (-1), —á—ë—Ä–Ω—ã–µ –≤–Ω–∏–∑ (+1)
            const startRow = piece === 'P' ? 6 : 1;
            const targetPiece = boardState[toRow][toCol];
            
            // –•–æ–¥ –≤–ø–µ—Ä—ë–¥ –Ω–∞ 1 –∫–ª–µ—Ç–∫—É
            if (toCol === fromCol && toRow === fromRow + direction && !targetPiece) {
                return true;
            }
            
            // –•–æ–¥ –≤–ø–µ—Ä—ë–¥ –Ω–∞ 2 –∫–ª–µ—Ç–∫–∏ —Å –Ω–∞—á–∞–ª—å–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
            if (toCol === fromCol && fromRow === startRow && 
                toRow === fromRow + 2 * direction && 
                !targetPiece && !boardState[fromRow + direction][fromCol]) {
                return true;
            }
            
            // –í–∑—è—Ç–∏–µ –ø–æ –¥–∏–∞–≥–æ–Ω–∞–ª–∏
            if (Math.abs(toCol - fromCol) === 1 && toRow === fromRow + direction && targetPiece) {
                const isTargetWhite = targetPiece === targetPiece.toUpperCase();
                const isPieceWhite = piece === piece.toUpperCase();
                if (isTargetWhite !== isPieceWhite) {
                    return true;
                }
            }
            
            return false;
        }
        
        function isValidRookMove(fromRow, fromCol, toRow, toCol, boardState) {
            if (fromRow !== toRow && fromCol !== toCol) return false;
            return isPathClear(fromRow, fromCol, toRow, toCol, boardState);
        }
        
        function isValidBishopMove(fromRow, fromCol, toRow, toCol, boardState) {
            if (Math.abs(toRow - fromRow) !== Math.abs(toCol - fromCol)) return false;
            return isPathClear(fromRow, fromCol, toRow, toCol, boardState);
        }
        
        function isPathClear(fromRow, fromCol, toRow, toCol, boardState) {
            const rowStep = fromRow === toRow ? 0 : (toRow > fromRow ? 1 : -1);
            const colStep = fromCol === toCol ? 0 : (toCol > fromCol ? 1 : -1);
            
            let row = fromRow + rowStep;
            let col = fromCol + colStep;
            
            while (row !== toRow || col !== toCol) {
                if (boardState[row][col]) return false;
                row += rowStep;
                col += colStep;
            }
            return true;
        }
        
        function createRoom() {
            roomId = Math.random().toString(36).substring(2, 8).toUpperCase();
            playerColor = 'white';
            
            database.ref('rooms/' + roomId).set({
                board: JSON.parse(JSON.stringify(initialBoard)),
                currentTurn: 'white',
                players: { white: 'host', black: null },
                createdAt: firebase.database.ServerValue.TIMESTAMP
            });
            
            document.getElementById('roomSection').innerHTML = `
                <h3>‚úÖ –ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞!</h3>
                <div class="room-code">üîë –ö–æ–¥: ${roomId}</div>
                <p>–û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –ø–∞–ø–µ üëá</p>
                <p><small>–û–∂–∏–¥–∞–Ω–∏–µ –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞...</small></p>
            `;
            gameStarted = true;
            listenToGame();
        }
        
        function joinRoom() {
            const code = document.getElementById('roomInput').value.trim().toUpperCase();
            if (!code) { alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã!'); return; }
            
            roomId = code;
            playerColor = 'black';
            
            database.ref('rooms/' + roomId + '/players/black').set('joined')
                .then(() => {
                    database.ref('rooms/' + roomId + '/players/white').set('host');
                    document.getElementById('roomSection').innerHTML = `
                        <h3>‚úÖ –í—ã –≤ –∏–≥—Ä–µ!</h3>
                        <div class="room-code">üîë –ö–æ–º–Ω–∞—Ç–∞: ${roomId}</div>
                        <p>–í—ã –∏–≥—Ä–∞–µ—Ç–µ –∑–∞ ‚ö´ —á—ë—Ä–Ω—ã—Ö</p>
                    `;
                    gameStarted = true;
                    listenToGame();
                })
                .catch(() => {
                    alert('–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–¥.');
                });
        }
        
        function listenToGame() {
            database.ref('rooms/' + roomId).on('value', (snapshot) => {
                const data = snapshot.val();
                if (data && data.board) {
                    board = data.board;
                    currentTurn = data.currentTurn;
                    renderBoard();
                    updateStatus();
                }
            });
        }
        
        function makeMove(fromRow, fromCol, toRow, toCol) {
            if (!gameStarted || !roomId) return;
            if ((playerColor === 'white' && currentTurn !== 'white') ||
                (playerColor === 'black' && currentTurn !== 'black')) {
                return;
            }
            
            const piece = board[fromRow][fromCol];
            if (!piece) return;
            
            // ‚úÖ –ü–†–û–í–ï–†–Ø–ï–ú –ü–†–ê–í–ò–õ–¨–ù–û–°–¢–¨ –•–û–î–ê
            if (!isValidMove(fromRow, fromCol, toRow, toCol, board)) {
                alert('‚ùå –ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ö–æ–¥!');
                return;
            }
            
            const newBoard = board.map(row => [...row]);
            newBoard[toRow][toCol] = newBoard[fromRow][fromCol];
            newBoard[fromRow][fromCol] = '';
            
            // –ü—Ä–µ–≤—Ä–∞—â–µ–Ω–∏–µ –ø–µ—à–∫–∏
            if (newBoard[toRow][toCol] === 'P' && toRow === 0) newBoard[toRow][toCol] = 'Q';
            if (newBoard[toRow][toCol] === 'p' && toRow === 7) newBoard[toRow][toCol] = 'q';
            
            const nextTurn = currentTurn === 'white' ? 'black' : 'white';
            
            database.ref('rooms/' + roomId).update({
                board: newBoard,
                currentTurn: nextTurn
            });
            
            selectedCell = null;
            validMoves = [];
        }
        
        function renderBoard() {
            const boardEl = document.getElementById('board');
            boardEl.innerHTML = '';
            
            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell ' + ((row + col) % 2 === 0 ? 'white' : 'black');
                    
                    if (board[row] && board[row][col]) {
                        cell.textContent = pieces[board[row][col]];
                    }
                    
                    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ñ–∏–≥—É—Ä—ã
                    if (selectedCell && selectedCell.row === row && selectedCell.col === col) {
                        cell.classList.add('selected');
                    }
                    
                    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Ö–æ–¥–æ–≤
                    if (validMoves.some(m => m.row === row && m.col === col)) {
                        cell.classList.add('valid-move');
                    }
                    
                    cell.addEventListener('click', () => handleCellClick(row, col));
                    boardEl.appendChild(cell);
                }
            }
        }
        
        function handleCellClick(row, col) {
            if (!gameStarted || !roomId) return;
            
            const piece = board[row] ? board[row][col] : null;
            
            // –ï—Å–ª–∏ —É–∂–µ –≤—ã–±—Ä–∞–Ω–∞ —Ñ–∏–≥—É—Ä–∞, –ø—Ä–æ–±—É–µ–º —Å–¥–µ–ª–∞—Ç—å —Ö–æ–¥
            if (selectedCell) {
                // –ï—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–∞ —Ç—É –∂–µ –∫–ª–µ—Ç–∫—É - —Å–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                if (selectedCell.row === row && selectedCell.col === col) {
                    selectedCell = null;
                    validMoves = [];
                    renderBoard();
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∫–ª–∏–∫ –¥–æ–ø—É—Å—Ç–∏–º—ã–º —Ö–æ–¥–æ–º
                if (validMoves.some(m => m.row === row && m.col === col)) {
                    makeMove(selectedCell.row, selectedCell.col, row, col);
                    return;
                }
            }
            
            // –ï—Å–ª–∏ —Ñ–∏–≥—É—Ä–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞ –∏–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–∞ –¥—Ä—É–≥—É—é —Å–≤–æ—é —Ñ–∏–≥—É—Ä—É
            if (piece) {
                const isWhitePiece = piece === piece.toUpperCase();
                const isMyPiece = (playerColor === 'white' && isWhitePiece) ||
                                 (playerColor === 'black' && !isWhitePiece);
                const isMyTurn = (playerColor === 'white' && currentTurn === 'white') ||
                                (playerColor === 'black' && currentTurn === 'black');
                
                if (isMyPiece && isMyTurn) {
                    selectedCell = { row, col };
                    // –í—ã—á–∏—Å–ª—è–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Ö–æ–¥—ã –¥–ª—è —ç—Ç–æ–π —Ñ–∏–≥—É—Ä—ã
                    calculateValidMoves(row, col);
                    renderBoard();
                }
            }
        }
        
        function calculateValidMoves(row, col) {
            validMoves = [];
            const piece = board[row][col];
            if (!piece) return;
            
            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    if (isValidMove(row, col, r, c, board)) {
                        validMoves.push({ row: r, col: c });
                    }
                }
            }
        }
        
        function updateStatus() {
            const statusEl = document.getElementById('status');
            const isMyTurn = (playerColor === 'white' && currentTurn === 'white') ||
                           (playerColor === 'black' && currentTurn === 'black');
            
            if (isMyTurn) {
                statusEl.textContent = 'üü¢ –í–∞—à —Ö–æ–¥!';
                statusEl.style.background = '#90EE90';
            } else {
                statusEl.textContent = '‚è≥ –•–æ–¥ –ø–∞–ø—ã...';
                statusEl.style.background = '#FFB6C1';
            }
        }
        
        function initBoard() {
            board = JSON.parse(JSON.stringify(initialBoard));
            renderBoard();
        }
        
        initBoard();
    </script>
</body>
</html>